# This workflow will build a golang project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-go
name: release-please

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write
  issues: write # needed if using builtin secrets.GITHUB_TOKEN


jobs:
  release-please:
    runs-on: windows-latest
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          release-type: simple

      - uses: actions/checkout@v4
      - name: Validates apps.json
        shell: pwsh
        run: if (-not (Get-Content -Raw apps.json | Test-Json)) { exit 1 }
             
      - name: Build apps
        if: steps.release.outputs.release_created
        shell: pwsh
        run: |
             & .\build.ps1 apps.json

      - name: Add script and versions
        if: steps.release.outputs.release_created
        shell: pwsh
        run: |
             cp install.ps1 build
             cp setup-user-env.ps1 build
             echo "Now creating archive"

      - name: Create archive
        if: steps.release.outputs.release_created
        shell: pwsh
        run: Compress-Archive build/* toolset.zip

      - name: Upload archive
        if: ${{steps.release.outputs.release_created}}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload ${{ steps.release.outputs.tag_name }} toolset.zip


